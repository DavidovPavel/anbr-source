"use strict";var anbr={domain:"saweb5.anbr.ru",protocol:"http",dbase:null,lang:"ru-RU",action:"send",HEIGHT_WIDGET:400,timeUpdate:1e4,TIME_ABORT:3e4,set:function(t){this.domain=t.domain||this.domain,this.dbase=t.dbase||this.dbase,this.protocol=t.protocol||this.protocol,this.lang=t.lang||this.lang,this.action=t.action||this.action}};anbr.net={method:"POST",url:function(t){var e=t.domain||anbr.domain,i=t.action||anbr.action;return document.location.protocol+"//"+e+"/api/extsrv/"+i},init:function(t,e,i,a,s,n){var r=a||this.method,o=this.url({domain:s,action:i.action});this.xhr=this.makeCORSRequest(o,r),this.xhr.onload=function(){clearTimeout(h),e.call(i,this)},this.xhr.setRequestHeader("Accept","application/json"),this.xhr.setRequestHeader("Content-Type","application/json"),this.xhr.setRequestHeader("key",window.location.href),this.xhr.onreadystatechange=function(){200===this.status?i.preloader.setAttribute("style","display:none;"):i.feedback.call(i.origin,{event:"errorNot200"})},this.xhr.onerror=function(){i.feedback.call(i.origin,{event:"errorXHR"})},this.xhr.onabort=function(){i.feedback.call(i.origin,{event:"abortXHR"})},i.preloader.setAttribute("style",""),this.xhr.send(t);var d=this.xhr,h=setTimeout(function(){i.preloader.setAttribute("style","display:none;"),d.abort()},anbr.TIME_ABORT)},makeCORSRequest:function(t,e){if("undefined"==typeof XMLHttpRequest)return null;var i=new XMLHttpRequest;return"withCredentials"in i?(i.withCredentials=!0,i.open(e,t,!0)):"undefined"!=typeof XDomainRequest?(i=new XDomainRequest,i.withCredentials=!0,i.open(e,t)):i=null,i}},anbr.widget=function(t){this.origin=t,this.canva=t.cid;var e=t.model.toJSON();if(this.switchOff=new Array,e.requestParameters&&(this._rid=e.requestParameters.rid,this._param=e.requestParameters.parameters,this._page=e.requestParameters.page,this._pagesize=e.requestParameters.pagesize,anbr.set(e.requestParameters)),this.typeName=e.typeName,this.Decoration=e.Decoration,this.Columns=e.ColumnCustomizations,this.timeUpdate=e.timeUpdate,this._update=e.update,this._height=e.height,this._width=e.width,this.mainTitle=e.title,this.ts="",this.getNextPage=!0,this.id="anbr_"+(new Date).getTime(),this.render(),!e.requestParameters.IsInvalid){this.action="send",e.id&&(this.widgetID=e.id,this.requestID=this._rid,this._rid&&anbr.net.init(this.setParam(),this.load,this));var i=["WidgetTable","WidgetRunning","WidgetGraph","WidgetMap"];this._update&&i.indexOf(this.typeName)!==-1&&(this.action="LatestPosts",this._page=1,setInterval(function(){var t=this._pagesize+this.origin.feedItems.length;anbr.net.init(this.setParam({ts:this.ts,pagesize:t}),this.load,this)}.bind(this),this.timeUpdate))}},anbr.widget.prototype={bind:function(t,e,i){e.length?Array.from(function(e,a){this.bind(t,a,i)},this):e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent&&e.attachEvent("on"+t,i)},getParams:function(t){var e=[];for(var i in t)e[i]=t[i];return e},setParam:function(t,e){t&&(this._rid=t.rid||this._rid,this._page=t.page||this._page,this._pagesize=t.pagesize||this._pagesize,this._param=t.parameters||this._param,this.ts=t.ts);var i={id:this._rid,page:this._page,pagesize:this._pagesize,pars:this._param,ts:this.ts};return e&&(i.useDefParams=!1),JSON.stringify(i)},setDecoration:function(){var t="background:#fff;",e="padding:10px 10px 0;font-size: 18px;",i="font-size:1em;cursor:default;text-decoration:none;",a="font-size:13px;overflow:auto;clear:both;"+("WidgetTable"!==this.typeName?"padding:20px;":"");this.Decoration&&(this.Decoration.CaptionIsVisible?(this.Decoration.CaptionBackground&&(e+="background:"+this.Decoration.CaptionBackground+";"),this.Decoration.BorderIsVisible&&(e+="border:solid 1px "+this.Decoration.CaptionBackground+";border-bottom:0;"),this.Decoration.CaptionForeground&&(i+="color:"+this.Decoration.CaptionForeground+";")):e+="display:none;",this.Decoration.ContainerIsTransparent?t="background:transparent;":this.Decoration.ContainerBackground&&(t="background:"+this.Decoration.ContainerBackground+";"),this.Decoration.ContainerForeground&&(a+="color:"+this.Decoration.ContainerForeground+";"),this.Decoration.BorderIsVisible?a+="border:solid 10px "+this.Decoration.CaptionBackground+";":e+="padding-bottom:10px;"),this.head.setAttribute("style",e),this.container.setAttribute("style",a+t),this.mainTitleSpan.setAttribute("style",i)},update:function(t,e){var i=!1;t.requestParameters&&(i=!0,this._rid=t.requestParameters.rid,this._param=t.requestParameters.parameters,this._page=t.requestParameters.page,this._pagesize=t.requestParameters.pagesize),this.typeName=t.typeName,this.Decoration=t.Decoration,this.Columns=t.ColumnCustomizations,this.setDecoration(),this.timeUpdate=t.timeUpdate,this._update=t.update,this._height=t.height,this._width=t.width,this._left=t.left,this._top=t.top,this.mainTitleSpan.textContent=this.mainTitle=t.title;var a=["WidgetTable","WidgetMap","WidgetGraph","WidgetRunning"];return i?("WidgetHtml"!==this.typeName&&(this.inload.innerHTML=""),anbr.net.init(this.setParam(t,e),this.load,this,null,t.requestParameters.domain,t.requestParameters.dbase)):a.indexOf(this.typeName)!==-1&&this.feedback.call(this.origin,{event:"visual",data:this.data.posts||this.data.feed.items,load:this.inload}),this},render:function(){var t=document.getElementById(this.canva);if(t){var e=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div"),s=document.createElement("span");if(e.setAttribute("class","anbr_head"),this.head=e,i.setAttribute("id",this.id),a.setAttribute("class","anbr_list"),i.appendChild(a),this.container=i,s.innerHTML='<svg><use xlink:href="#loader-rotator"></use></svg>',s.setAttribute("style","display:none;"),s.setAttribute("class","loader Preloader"),this.preloader=s,this.mainTitleSpan=document.createElement("span"),this.mainTitleSpan.textContent=this.mainTitle,e.appendChild(this.mainTitleSpan),"WidgetTable"===this.typeName){var n=document.createElement("div");n.setAttribute("class","number-update"),this.head.appendChild(n);var r=document.createElement("span");r.setAttribute("class","font-icon font-icon-filter"),this.head.appendChild(r);var o=document.createElement("span");o.innerHTML='<svg class="view-all-list"><use xlink:href="#view-all-list"></use></svg>',this.head.appendChild(o);var d=document.createElement("div");d.setAttribute("class","filter-panel"),a.appendChild(d)}this.setDecoration(),e.appendChild(s),t.appendChild(e),t.appendChild(i);var h=this,l=0;"WidgetTable"===this.typeName&&this.bind("scroll",a.parentNode,function(){"none"!==a.style.display&&this.scrollTop>l&&this.scrollTop>(this.scrollHeight-anbr.HEIGHT_WIDGET)/2&&(l=this.scrollTop,h.getNextPage&&(h.getNextPage=!1,h._pagesize=h.inload.getElementsByTagName("tr").length+h.origin.feedItems.length,anbr.set({action:"send"}),anbr.net.init(h.setParam({pagesize:h._pagesize,page:2}),h.nextPageload,h)))});var p=document.createElement("span");p.setAttribute("style","clear:both;display:block;"),this.head.appendChild(p),this.inload=a}},nextPageload:function(t){var e=JSON.parse(t.response);if(e){var i=e.posts||e.feed.items;anbr.set({action:"LatestPosts"}),this.getNextPage=!0,this.feedback.call(this.origin,{event:"update",data:i})}},done:function(t){return this.feedback=t,this},parsePosts:function(){var t=this.data.posts;this.feedback.call(this.origin,{event:"post",data:t})},parseFeed:function(){if(!this.data.feed)return null;var t=(this.data.feed.items,this.inload.getElementsByTagName("table")[0]),e=this.data.feed.head||[];this.linksCollection=this.data.feed?this.data.feed.links:this.linksCollection||[],!t&&e.length&&(t=document.createElement("table"),t.setAttribute("class","widget-table"),this.inload.appendChild(t)),this.data.feed.links=this.linksCollection,this.feedback.call(this.origin,{event:"visual",data:this.data.feed.items,load:this.inload})},load:function(t){var e=JSON.parse(t.response);e&&(this.data=e,e.feed,this.ts=e.ts,e.posts?this.parsePosts():this.parseFeed(),anbr.set({action:"LatestPosts"}))}};