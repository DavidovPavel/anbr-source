"use strict";require.config({paths:{"@":"@Services/sources"}}),define(["app","access","i18n!nls/resources.min","global.view.headerView","services.sources.mainView","services.sources.mainView_new","global.radio.loader"],function(e,t,i,n,o,l){return{init:function(){e.access=t.data.Points,e.baseType=t.data.Kind,$.ajaxSetup({headers:{key:$.ajaxSettings.url}});var s=Mn.Application.extend({region:"main",onStart:function(){Backbone.history&&Backbone.history.start(),"NEW"===Backbone.history.fragment&&Backbone.history.navigate("NEW")}}),c=Mn.AppRouter.extend({routes:{"":function(){$(document).find("head>title").text(i.titleSearchRobots),a.getRegion().show(new o({model:new Backbone.Model({BySaType:null,SelectedCountries:[i.Lang]})})),(new n).render()},NEW:function(){a.getRegion().show(new l),(new n).render()}}}),a=new s,r=new c;a.router=r,a.start(),$(".logo").on("click",function(){location.href=location.pathname})}}}),define("services.sources.mainView",["i18n!nls/resources.min","filtersSourcesView","listSourcesView"],function(e,t,i){return Mn.View.extend({template:templates["search-sources"],templateContext:{Resources:e},events:{"click .toform:not(.disabled)":"toform","click @ui.start:not(.disabled)":"start"},ui:{snum:"#selected-num",samount:"#select-amount",balance:"#balance",start:".start",meter:"#source-select-meter"},initialize:function(){this.collection=new Backbone.Collection,this.collection.url="/api/sources/persisted/"+this.model.id,this.paramCollection=new Backbone.Collection},regions:{filters:"#Filters",list:"#ListTemplate"},onBeforeRender:function(){$.get("/api/search/balance").done(function(e){this.ui.balance.text(e.toFixed(2)),this.ui.meter.attr("data-meter-max",e).gtkMeter()}.bind(this))},onRender:function(){this.showChildView("list",new i),this.showChildView("filters",new t({model:this.model})),this.model.id&&(Backbone.Radio.channel("loader").trigger("show",this.$el),this.collection.fetch({reset:!0}))},collectionEvents:{reset:function(){Backbone.Radio.channel("loader").trigger("hide"),this.getChildView("list").collection.each(function(e){e.set("checked",!!this.collection.get(e))},this),this.getChildView("list").getChildView("selected").collection.reset(this.collection.models)}},childViewEvents:{"filter:send":function(e){var t=e.model;t?t.get("on")?this.paramCollection.add(t):this.paramCollection.remove(t):this.paramCollection.reset();var i={DicItems:this.paramCollection.pluck("ID"),SearchText:this.getChildView("list").ui.searchText.val()};i.DicItems.push(this.options.DicID),Backbone.Radio.channel("loader").trigger("show",this.$el),$.post("/api/sources/filterby",i).done(function(e){Backbone.Radio.channel("loader").trigger("hide"),this.getChildView("list").collection.reset(e),this.getChildView("list").collection.each(function(e){e.set("checked",!!this.collection.get(e))},this)}.bind(this))},"filter:change:set":function(e){var t=e.model.id;t?(Backbone.Radio.channel("loader").trigger("show",this.$el),this.collection.url="/api/sources/persisted/"+t,this.collection.fetch({reset:!0})):this.collection.reset()},"filter:destroy:set":function(){this.collection.reset()}},onChildviewShowSelectedRobots:function(){this.getChildView("list").getChildView("selected").collection.reset(this.collection.models)},onChildviewListChanged:function(e){e.get("checked")?this.collection.add(e):this.collection.remove(e);var t=0,i=this.collection.length;this.collection.each(function(e){t+=e.get("price")}),this.getChildView("list").ui.amountSel.text(i),i?this.ui.start.removeClass("disabled"):this.ui.start.addClass("disabled"),this.ui.snum.text(i),this.ui.samount.text(t.toFixed(2)),parseFloat(this.ui.balance.text())>0&&this.ui.meter.data("meter-val",t).gtkMeter("update")}})}),define("services.sources.mainView_new",["i18n!nls/resources.min","filtersSourcesView","listSourcesView"],function(e,t,i){return Mn.View.extend({template:templates["new-search"],templateContext:{Resources:e},events:{},ui:{},initialize:function(){},regions:{},onBeforeRender:function(){},onRender:function(){},collectionEvents:{},childViewEvents:{}})}),define("services.sources.sourcesView",["i18n!nls/resources.min","global.view.dialog","robots.mainView"],function(e,t,i){return Mn.View.extend({template:_.template("<div></div>"),regions:{d:{el:"div",replaceElement:!0}},onRender:function(){this.showChildView("d",new t({className:"full",content:new i({model:this.model,DicID:this.options.DicID}),title:e.selSourcesTitle,footer:new Backbone.Collection([{id:"back",title:e.toform},{id:"start",title:e.saveCollRobots,className:"next right"}])}))},onChildviewControlsButtonClick:function(e){switch(e.model.id){case"back":this.remove();break;case"start":this.saveCollection()}},saveCollection:function(){var t=[],i=0,n=this.getChildView("container").collection;n.each(function(e){t.push(e.id),i+=e.get("price")});var o=this.model.get("view").model,l={method:"POST",url:"/api/sources/persisted",data:{Sources:t,BySATypeSelectedValue:o.get("BySaType"),SearchPackUID:o.get("SearchPackUID"),SearchPackName:o.get("SearchPackName")}};if(!t.length)return Backbone.trigger("message:warning",{title:e.alert,message:e.errorsavecoll}),null;$.ajax(l).done(function(e){o.get("SearchPackUID")||o.set("SearchPackUID",e),o.set({SourcesCount:n.length,Sum:i}),this.triggerMethod("save:robots:collection",l),this.remove()}.bind(this))}})}),define("listSourcesView",["i18n!nls/resources.min","c/SimpleTableView","global.behaviors.input","global.view.dialog"],function(e,t,i,n){var o=Backbone.Collection.extend({model:Backbone.Model.extend({defaults:{id:null,title:"",property:[],description:"",price:0,currency:""}}),url:function(){return"/api/sources"}}),l=Mn.View.extend({template:"#source-info-template",templateContext:{Resources:e}});return Mn.View.extend({template:templates["list-sources"],templateContext:{Resources:e},behaviors:{input:i},ui:{searchText:"#search-text",amountAll:".amount-all",amountSel:".amount-selected"},regions:{all:"#all-list",selected:"#selected-list",win:"#info-window"},events:{"keypress @ui.searchText":function(e){13===e.keyCode&&$.trim(this.ui.searchText.val())&&this.triggerMethod("filter:send",this)},"click #input-search .search":function(e){this.triggerMethod("filter:send",this)},"click .all":function(e){$(e.target).addClass("active"),this.$(".sel").removeClass("active"),this.getChildView("all").$("input ~ label").removeClass("disabled"),this.getRegion("all").$el.show(),this.getRegion("selected").$el.hide()},"click .sel:not(.active)":function(e){$(e.target).addClass("active"),this.$(".all").removeClass("active"),this.triggerMethod("show:selected:robots"),this.getRegion("all").$el.hide(),this.getRegion("selected").$el.show()}},initialize:function(){this.collection=new o},onRender:function(){var i=[{id:0,title:e.title,width:"80%",subTemplate:'<input type="checkbox" id="ch-all" class="g-form--checkbox"><label for="ch-all" style="color:#fff;"><%- title %></label>'},{id:1,title:e.price,width:"20%"}],n=[{id:0,title:e.title,width:"80%"},{id:1,title:e.price,width:"20%"}];this.showChildView("all",new t({collection:this.collection,head:new Backbone.Collection(i),rowTemplate:'<td><input type="checkbox" id="ch-<%- id %>" class="g-form--checkbox"><label for="ch-<%- id %>"><%- title %>&nbsp;<span data-cmd="info" data-icon="icon-info"></span></label></td><td><%- price?price:Resources.freeTitle %></td>'})),this.showChildView("selected",new t({collection:new Backbone.Collection,head:new Backbone.Collection(n),rowTemplate:'<td><span data-icon="icon-trash" data-cmd="clear"></span>&nbsp;<%- title %>&nbsp;<span data-cmd="info" data-icon="icon-info"></span></td><td><%- price?price:Resources.freeTitle %></td>'}))},childViewEvents:{"change:input:row":function(e){e.model.set("checked",$(event.target).prop("checked"))},"table:row:cmd":function(t,i){"clear"===$(i.target).data("cmd")&&(t.model.set("checked",!1),this.getChildView("selected").collection.remove(t.model),this.ui.amountSel.text(this.getChildView("selected").collection.length)),"info"===$(i.target).data("cmd")&&this.showChildView("win",new n({title:e.information,content:new l({model:t.model})}))}},collectionEvents:{reset:function(){this.ui.amountAll.text(this.collection.length)}},onChildviewTableRowModelChanged:function(e){this.triggerMethod("list:changed",e)}})}),define("filtersSourcesView",["i18n!nls/resources.min","global:collection:dictionary"],function(e,t){var i=Mn.CollectionView.extend({className:"list-group",tagName:"ul",childView:Mn.View.extend({tagName:"li",className:"btn-link-filter",template:_.template("<%- Title %>"),triggers:{click:"filter:send"},onFilterSend:function(){this.model.set("on",!this.model.get("on")),this.$el.toggleClass("active")},onRender:function(){this.model.get("on")?this.$el.addClass("active"):this.$el.removeClass("active")}}),childViewOptions:function(e){e.set("on",-1!==this.options.current.indexOf(e.get("DicCodeItem"))),e.get("on")&&this.triggerMethod("filter:send",{model:e})},childViewTriggers:{"filter:send":"filter:send"}}),n=Mn.CollectionView.extend({className:"filter-list source-collection",tagName:"ul",childView:Mn.View.extend({tagName:"li",className:"btn-link-coll",template:_.template('<% if(!IsSystem && SearchPackUID) {%><i data-icon="icon-close-xs"></i><% } %><span class="radio-button <% if(active){%>checked<%}%>"><span></span></span><span class="title"><%- SearchPackName %></span>'),modelEvents:{"change:active":function(){this.render()}},triggers:{'click i[data-icon="icon-close-xs"]':"filter:destroy:set",click:"filter:change:set"},onFilterChangeSet:function(){var e=this.model.collection.findWhere({active:!0});e&&e.set("active",!1),this.model.set("active",!0)},onFilterDestroySet:function(){Backbone.trigger("message:confirm",{title:e.sure,message:"",fx:function(){this.model.destroy()},ctx:this})},onRender:function(){this.model.get("active")?this.$el.addClass("active"):this.$el.removeClass("active")}}),childViewOptions:function(e){e.id===this.model.id?e.set("active",!0):e.set("active",!1)},childViewTriggers:{"filter:change:set":"filter:change:set","filter:destroy:set":"filter:destroy:set"}}),o=Mn.View.extend({template:templates["filters-selections-sources"],templateContext:{R:e},regions:{system:{el:".IsSystem",replaceElement:!0},custom:{el:".Custom",replaceElement:!0}},onRender:function(){var e=this.model.collection.groupBy("IsSystem");e.true&&this.showChildView("system",new n({collection:new Backbone.Collection(e.true),model:this.model})),e.false&&this.showChildView("custom",new n({collection:new Backbone.Collection(e.false),model:this.model}))},childViewTriggers:{"filter:destroy:set":"filter:destroy:set","filter:change:set":"filter:change:set"}});return Mn.View.extend({template:templates["filter-sources"],templateContext:{R:e},regions:{selections:"#selections",ByPayment:{el:"#ByPayment",replaceElement:!0},ByStatus:{el:"#ByStatus",replaceElement:!0},ByCountry:{el:"#ByCountry",replaceElement:!0},BySrcKind:{el:"#BySrcKind",replaceElement:!0},ByInfo:{el:"#ByInfo",replaceElement:!0}},events:{"click .btn-collapse":function(e){var t=$(e.target).next("div.collapse");t.is(".on")?t.removeClass("on").slideUp():t.addClass("on").slideDown()},"click .btn-link-clear":function(){var e=this.getRegions();_.each(e,function(e){var t=e.currentView;t&&t.collection&&t.collection.each(function(e){e.get("on")&&(e.set("on",!1),t.children.findByModel(e).render())})}),this.triggerMethod("filter:send",{})}},onRender:function(){this.model.collection&&this.showChildView("selections",new o({model:this.model})),t.done(function(e){e.each(function(e){this.hasRegion(e.get("DicCode"))&&this.showChildView(e.get("DicCode"),new i({collection:new Backbone.Collection(e.get("DicItems")),current:this.model.get("SelectedCountries")||[]}))},this)},this)},childViewTriggers:{"filter:destroy:set":"filter:destroy:set","filter:change:set":"filter:change:set","filter:send":"filter:send"}})}),function(e){var t={mode:null,min:0,max:100,val:33,colorMain:"#b0d2c8",colorFiller:"#3bb54c",colorStick:"#3bb54c",rotateFrom:0,rotateTo:166,rotateFrom1:7.3,rotateTo1:172.7,anim:"all 1s"};e.fn.gtkMeter=function(i){var n=e.extend({},t,i);return this.each(function(){var t,i=e(this).data("meter-min"),o=e(this).data("meter-max"),l=e(this).data("meter-val");(void 0==i||""==i)&&(i=n.min),(void 0==o||""==o)&&(o=n.max),(void 0==l||""==l)&&(l=n.val),t=e.fn.gtkMeter.mathmeter(i,o,l,n),e.fn.gtkMeter.svg(e(this)),e.fn.gtkMeter.stylize(e(this),t,n)})},e.fn.gtkMeter.mathmeter=function(e,t,i,n){var o=i/(t/100),l={};return l.one=(n.rotateTo-n.rotateFrom)/100*o,l.two=(n.rotateTo1-n.rotateFrom1)/100*o,l.two=l.two+6.6,l},e.fn.gtkMeter.svg=function(e){return e.find("svg.gtk-meter").length>0?e:e.append('<svg class="gtk-meter" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 93 41"><path class="gtk-meter-main" d="M46.5,0C20.8,0,0,20.8,0,46.5C0,72.2,20.8,93,46.5,93S93,72.2,93,46.5C93,20.8,72.2,0,46.5,0z M46.5,87C24.1,87,6,68.9,6,46.5C6,24.1,24.1,6,46.5,6S87,24.1,87,46.5C87,68.9,68.9,87,46.5,87z"/><path class="gtk-meter-filler" style="-webkit-transform: rotate(0deg); -ms-transform: rotate(0deg); transform: rotate(0deg);" d="M40.8,92.7c25.5,3.1,48.7-15,51.8-40.5l-6-0.7c-2.7,22.2-22.9,38-45.1,35.3S3.6,63.8,6.3,41.6l-6-0.7C-2.8,66.3,15.4,89.5,40.8,92.7z"/><g class="gtk-meter-stick"><rect fill="none" x="46.5" y="46.2" width="41.8" height="0.7"/><polygon points="5.5,46.2 46.5,45.2 46.5,47.9 5.5,46.8 "/></g></svg>')},e.fn.gtkMeter.stylize=function(e,t,i){var n=" -webkit-transition: "+i.anim+"; -moz-transition: "+i.anim+"; -o-transition: "+i.anim+"; transition: "+i.anim+"; ",o=" -webkit-transform: rotate("+t.one+"deg); -ms-transform: rotate("+t.one+"deg); transform: rotate("+t.one+"deg); ",l=" -webkit-transform: rotate("+t.two+"deg); -ms-transform: rotate("+t.two+"deg); transform: rotate("+t.two+"deg); ";return e.find(".gtk-meter-main").attr("fill",i.colorMain),e.find(".gtk-meter-filler").attr("fill",i.colorFiller).attr("style",n+" transform-origin: 51.8% 10.3%; "+o),e.find(".gtk-meter-stick").attr("fill",i.colorStick).attr("style",n+" transform-origin: 50% 50%; "+l),e},e(function(){})}(window.jQuery||window.Zepto);