define(["app","@/views/SearchView","@/views/ListView","storage"],function(n,t,i,r){"use strict";var u=$("<span class='icon-progress'><span><\/span><span><\/span><span><\/span><span><\/span><span><\/span><span><\/span><span><\/span><span><\/span><span><\/span><span><\/span><\/span>");return Backbone.View.extend({el:$("#CheckList"),events:{"click .nav a":"jump"},jump:function(t){t.preventDefault();n.Select.set("page",1);n.navigate(n.Select.fullpath());var i=$(t.target).closest("a");this.tab(i).trans(i.attr("href"))},tab:function(n){return this.$("ul.nav li.active").removeClass("active"),this.$(".tab-content>div").hide(),n.parent().addClass("active"),this},trans:function(i){this.$(i).show();switch(i){case"#my-checks":this.mycheck();break;case"#all-checks":this.search();break;case"#search-checks":this.searchInit||(this.searchInit=!0,(new t).render().fill())}return n.Select.set("list",i.substr(1)),n.navigate(n.Select.fullpath()),this},initialize:function(){this.timers={};this.totalCheck();let t=n.Select.get("list"),i=$.trim(t)?this.$(`a[aria-controls='${t}']`):this.$("a").eq(0);this.tab(i);this.trans(i.attr("href"));Backbone.on("storage:check-add",this.showChecking,this);require(["signalR"],()=>{require(["/signalr/hubs"],()=>{require(["/scripts/IWC-SignalR-master/signalr-patch.js","/scripts/IWC-SignalR-master/iwc-signalr.js"],()=>{var n=SJ.iwc.SignalR.getHubProxy("Ticker",{client:{infoActiveChecks:n=>{console.log("Инфо об активных проверках",{ids:n}),this.infoActiveChecks(n)}}})})})})},infoActiveChecks:function(n){n.length||(r.checkCollection&&r.checkCollection.reset(),this.stopMonitoring());this.$("table.List>tbody tr").each((n,t)=>{var i=$(t).find(".icon-progress");i.get(0)&&(i.remove(),$(t).find("td:nth-last-child(2)").append($("<svg class='icon icon-check'><use xlink:href='#icon-check'><\/use><\/svg>")))});Array.from(n,this.checkIcon,this)},checkIcon:function(n){let t=this.$(`tr[data-id='${n}']`).find("td:nth-last-child(2)");return t.find("svg").remove(),t.html(u.clone()),this},showChecking:function(){let n="#my-checks";this.tab(this.$(`a[href='${n}']`)).trans(n).totalCheck()},totalCheck:function(){return $.get("/api/totalcheck").done(n=>{this.$('ul a[href="#my-checks"] span').text(`(${n[0]})`),this.$('ul a[href="#all-checks"] span').text(`(${n[1]})`)}),this},mycheck:function(){return this.mycheckInit||(this.mycheckInit=!0,this.mylist=new i({el:this.$("#my-checks")}),this.mylist.collection.url="/api/mycheck?page=1",this.listenTo(this.mylist,"to:page",function(n){this.mylist.newPage=n;this.mylist.fetch()})),this.mylist.newPage=n.Select.get("page"),this.mylist.fetch().done(function(n){this.$('ul a[href="#my-checks"] span').text(`(${n.collection.models[0].get("pagination").totalItems})`);this.chooseStatus();this.callback&&this.callback.call(this.context)},this),this},search:function(){return this.allcheckInit||(this.allcheckInit=!0,this.alllist=new i({el:this.$("#all-checks")}),this.alllist.collection.url="/api/interestObjects?onlyMeta=&profileID=&paramID=&typeID=&inputText=&page=1",this.listenTo(this.alllist,"to:page",function(n){this.alllist.newPage=n;this.alllist.fetch()})),this.alllist.newPage=n.Select.get("page"),this.alllist.fetch().done(function(n){this.$('ul a[href="#all-checks"] span').text(`(${n.collection.models[0].get("pagination").totalItems})`);this.chooseStatus();this.callback&&this.callback.call(this.context)},this),this},chooseStatus:function(){var n=r.checkCollection;n&&n.each(n=>{this.checkIcon(n.id),this.checkProcess(n.id)})},checkProcess:function(n){var t=app;require(["signalR"],function(){require(["/signalr/hubs"],function(){require(["/scripts/IWC-SignalR-master/signalr-patch.js","/scripts/IWC-SignalR-master/iwc-signalr.js"],function(){var i=t.getContext(),r=SJ.iwc.SignalR.getHubProxy("Ticker",{client:{}});r.server.startMonitoringTasks(i.key,n)})})})},stopMonitoring:function(){},done:function(n,t){return this.callback=n,this.context=t,this}})});