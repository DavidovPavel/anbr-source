define(["app","i18n!nls/resources","@/views/sources/FiltersView","@/views/sources/ListSourcesView","/js/libs/gtkMeter.js"],function(n,t,i,r){"use strict";var u='<fieldset><legend class="text-center"><%= Resources.selSourcesTitle %><\/legend><div class="row row-26 mrg-b-24"><div class="col-sm-3"><button class="btn btn-flagy-rev btn-blue fullsize toform"><%= Resources.toform %><\/button><\/div><div class="col-sm-6"><div class="text-center"><div id="source-select-meter" data-meter data-meter-min="0" data-meter-val="0"><\/div><div class="text-left"><%= Resources.selSources %>: <span id="selectedSources">0<\/span><br/><%= Resources.sum %>: <span id="SelectAmount">0.00<\/span>&nbsp;<span class="Currency"><\/span><br/><%= Resources.balance %>: <span class="text-info"><span id="Balance">0<\/span>&nbsp;<span class="Currency"><\/span><\/span><\/div><\/div><\/div><div class="col-sm-3"><button class="btn btn-flagy btn-blue fullsize Start"><%= Resources.saveCollRobots %><\/button><\/div><\/div><div class="row row-26"><div class="col-sm-3" id="Filters"><\/div><div class="col-sm-9" id="ListTemplate"><\/div><\/div><\/fieldset>';return Backbone.View.extend({el:$("#Sources"),events:{"click .toform:not(.disabled)":"toform","click button.Start":"start"},toform:function(){this.model.id?Backbone.trigger("to:form",{selected:this.list.basket,saType:this.list.saType}):Backbone.trigger("to:form",{remove:this.model})},initCounter:function(n){this.selected=0;this.sum=0;n.length||this.dats();n.each(this.add,this)},add:function(n){this.selected++;this.sum+=n.get("price");this.dats()},remove:function(n){this.selected>0&&(this.selected--,this.sum-=n.get("price"),this.dats())},dats:function(){this.$("#selectedSources").text(this.selected);this.$("#SelectAmount").text(this.sum.toFixed(2));this.balance>this.sum?this.$("#source-select-meter").data("meter-val",this.sum).gtkMeter("update"):Backbone.trigger("message:warning",{title:"Warning!",message:"no money!"})},initialize:function(){this.selected=0;this.sum=0;this.balance=0;this.list=new r;this.list.basket.on("reset",this.initCounter,this);this.list.basket.on("add",this.add,this);this.list.basket.on("remove",this.remove,this);this.filters=new i;this.list.listenTo(this.filters,"listsources:send",this.list.byfilter);this.list.listenTo(this.filters,"listsources:changecollection",this.list.changecollection);this.listenTo(this.filters,"listsources:changecollection",function(n){this.model=n;this.viewCRobots.current=n;this.viewCRobots.$el.closest("div.pull-right").find(".show-source-collection-manage").text(n.get("SearchPackName"))});this.listenTo(this.list,"change:selected",function(){this.list.basket.length?this.$(".Start").removeClass("disabled"):this.$(".Start").addClass("disabled")})},render:function(){return this.$el.html(_.template(u)({Resources:t})),this.list.setElement(this.$("#ListTemplate")).render(),this.filters.setElement(this.$("#Filters")).render(),this},fill:function(n){!n.id;this.viewCRobots||(this.viewCRobots=n.view);this.viewCRobots.current=n;this.viewCRobots.$el.closest("div.pull-right").find(".show-source-collection-manage").text(n.get("SearchPackName"));this.model=n;this.list.model=n;this.filters.initCollection(n).initCountry(n.get("SelectedCountries")).send();this.fillBalance()},fillBalance:function(){$.get("/api/search/balance").done(n=>{this.balance=parseFloat(n),this.$("#Balance").text(n.toFixed(2)),this.$("#source-select-meter").attr("data-meter-max",n),this.$("#source-select-meter").gtkMeter()}).fail(()=>clearInterval(this.tickBalance))},start:function(){let n=this.list.basket.pluck("id"),i={method:"POST",url:"/api/sources/persisted",data:{Sources:n,BySATypeSelectedValue:this.model.get("BySaType"),SearchPackUID:this.model.id,SearchPackName:this.model.get("SearchPackName")}};if(!n.length)return Backbone.trigger("message:warning",{title:t.alert,message:t.errorsavecoll}),null;$.ajax(i).done(n=>{this.model.id||this.model.set("id",n),this.toform()})}})});