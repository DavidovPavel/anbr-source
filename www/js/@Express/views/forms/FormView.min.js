define(["app","i18n!nls/resources","@Analyst/collections/DictionaryCollection","@/views/ListView","g/files/AttachFile","libs/jquery/jquery.cookie","jqueryui","/Scripts/jquery.mCustomScrollbar.concat.min.js","/js/libs/jquery/jquery.form.min.js"],function(n,t,i,r,u){"use strict";var o=`<button type="button" class="dropdown-toggle btn-clear text-info synonimus-link" aria-haspopup="true" aria-expanded="false" ><span class="anbr-tooltip top"><%= Resources.tt1 %><span position="bottom"></span></span><svg class="icon icon-edit"><use xlink:href="#icon-edit"/></svg><%= Resources.tt2 %>: <span id="synNums">0</span></button>
                     <div class="dropdown-menu synonimus" style="margin-top:-254px;">
                         <span class="dropdown-menu_arrow"></span>
                         <span class="dropdown-menu_close hideSyn"><svg class="icon icon-close"><use xlink:href="#icon-close"/></svg></span>
                         <div class="menu-info-message">
                             <div class="form-group">
                                 <label for="add-syn"><%= Resources.addsyn %></label>
                                 <div class="input-group">
                                     <input type="text" class="form-control" id="add-syn" placeholder="">
                                     <div class="input-group-addon add-btn"><svg class="icon icon-plus"><use xlink:href="#icon-close"/></svg></div>
                                 </div></div></div>
                         <div class="menu-alert-list ListSynonims"><ul></ul></div></div>`,e=`<div data-uid='<%= SearchPackUID %>'><span><%= SearchPackName?SearchPackName:'...' %></span><span class='cmd'>
                        <% if(!IsSystem){ %><button type='button' class='edit'><svg class='icon icon-pencil'><use xlink:href='#icon-pencil'></use></svg></button><% } %>
                        <button type='button' class='view'><svg class='icon icon-eye'><use xlink:href='#icon-eye'></use></svg></button>
                        <% if(!IsSystem){ %><button type='button' class='clear'><svg class='icon icon-close'><use xlink:href='#icon-close'></use></svg></button><% } %>
                        </span></div>`,f={10021:1002,10022:1003,10023:1004},h=Backbone.View.extend({events:{"click .synonimus-link":"showSyn","click .hideSyn":"hideSyn","click .add-btn":"add","click .clearItem":"clear"},add:function(){var n=this.$("#add-syn").val(),t;this.$("#add-syn").css({"border-color":""});$.trim(n)&&!this.collection.findWhere({Value:n})?(t=new Backbone.Model({Value:n}),this.collection.add(t)):this.$("#add-syn").css({"border-color":"red"})},addItem:function(n){this.$("ul").prepend(_.template('<li><%= Value %><span role="button" class="clearItem"><svg class="icon icon-close"><use xlink:href="#icon-close"/><\/svg><\/span><\/li>')(n.toJSON()));this.$("#synNums").text(this.collection.length);this.$(".menu-alert-list").mCustomScrollbar("update")},clear:function(n){var t=$(n.target).closest("li"),i=t.text(),r=this.collection.findWhere({Value:i});this.collection.remove(r);t.remove();this.$("#synNums").text(this.collection.length);this.$(".menu-alert-list").mCustomScrollbar("update")},hideSyn:function(){this.$("#add-syn").val("");this.$(".synonimus").slideUp()},showSyn:function(){this.$(".synonimus").slideDown(function(){$(this).find(".dropdown-menu_arrow").css("margin-top",248)})},initialize:function(){this.collection=new Backbone.Collection;this.collection.on("reset",this.list,this);this.collection.on("add",this.addItem,this)},list:function(){this.$("ul").empty();this.$("#synNums").text(this.collection.length);this.collection.each(this.addItem,this)},render:function(){var n=this.model.toJSON();return n.Resources=t,this.$el.html(_.template(o)(n)),this.$(".menu-alert-list").mCustomScrollbar(),this},fetch:function(){this.model.set("id",0);$.ajax({method:"POST",contentType:"application/json; charset=utf-8",url:"/api/synonyms",data:JSON.stringify(this.model.toJSON())}).done(n=>{let t=[];Array.from(n,n=>t.push({Value:n}));this.collection.reset(t)})},show:function(){this.$("button").show()},hide:function(){this.$("button").hide();this.hideSyn()}}),c=Backbone.View.extend({events:{"click .add-btn":"add","click .save":"save","click .cancel":"cancel","click .view":"view","click .edit":"edit","click .clear":"clear","click .list-cmd-panel div":"setCurrent","click input":"clickInput"},clickInput:function(n){n.stopPropagation()},cancel:function(n){n.stopPropagation();var t=$(n.target).closest("div"),i=this.collection.get(t.attr("data-uid"));this.re(i)},save:function(n){n.stopPropagation();var t=$(n.target).closest("div"),i=t.find("input"),r=this.collection.get(t.attr("data-uid"));$.trim(i.val())&&(r.save({SearchPackName:i.val()}),this.re(r))},re:function(n){var t=this.$(`div[data-uid='${n.id}']`);t.html(_.template(`<span><%= SearchPackName?SearchPackName:'...' %></span><span class='cmd'>
                        <% if(!IsSystem){ %><button type='button' class='edit'><svg class='icon icon-pencil'><use xlink:href='#icon-pencil'></use></svg></button><% } %>
                        <button type='button' class='view'><svg class='icon icon-eye'><use xlink:href='#icon-eye'></use></svg></button>
                        <% if(!IsSystem){ %><button type='button' class='clear'><svg class='icon icon-close'><use xlink:href='#icon-close'></use></svg></button><% } %>
                        </span>`)(n.toJSON()))},edit:function(n){n.stopPropagation();var t=$(n.target).closest("div"),i=this.collection.get(t.attr("data-uid"));t.html(_.template(`<input type='text' value='<%= SearchPackName %>' /><span class='cmd edit-view' data-uid='<%= SearchPackUID %>'>
                <button type='button' class='cancel'><svg class='icon button-cancel'><use xlink:href='#button-cancel'></use></svg></button>
                <button type='button' class ='save'><svg class ='icon icon-check'><use xlink: href='#icon-check'></use></svg></button></span>`)(i.toJSON()))},setCurrent:function(n){n.stopPropagation();var i=$(n.target).closest("div").attr("data-uid"),r=t.choose;this.current=i?this.collection.get(i):this.collection.findWhere({SearchPackUID:null});this.current&&(r=this.current.get("SearchPackName"));this.$el.closest("div.pull-right").find(".show-source-collection-manage").text(r);$.cookie(`anbr.check.${this.model.get("typeid")}.sourceid`,i);this.$el.slideUp()},add:function(n){var i,t;if(n.stopPropagation(),this.$("#add-collection").css({"border-color":""}),i=$.trim(this.$("#add-collection").val()),i){t=new this.collection.model({SearchPackName:i,SearchPackUID:null,BySaType:f[this.model.get("typeid")],SelectedCountries:this.model.get("selectedCountries"),IsSystem:!1});t.on("change:id",function(n,t){n.set("SearchPackUID",t);this.current=n;$.cookie(`anbr.check.${this.model.get("typeid")}.sourceid`,t);this.list()},this);this.collection.add(t);t.view=this;Backbone.trigger("to:robots",t)}else this.$("#add-collection").css({"border-color":"red"})},clear:function(n){n.stopPropagation();var i=$(n.target).closest("div").attr("data-uid"),t=this.collection.get(i);t.destroy();this.collection.remove(t)},view:function(n){n.stopPropagation();var i=$(n.target).closest("div").attr("data-uid"),t=this.collection.get(i);t.set({BySaType:f[this.model.get("typeid")],SelectedCountries:this.model.get("selectedCountries")});t.view=this;Backbone.trigger("to:robots",t);this.$el.hide()},initialize:function(){this.collection=new Backbone.Collection;this.collection.model=Backbone.Model.extend({idAttribute:"SearchPackUID"});this.collection.on("reset",this.list,this);this.collection.on("remove",this.list,this);this.collection.url="/api/sources/searchpacks/"+f[this.model.get("typeid")];this.collection.fetch({reset:!0});Backbone.on("to:form",n=>{this.$("#add-collection").val("");let i=this.collection.where(n=>!n.id);this.collection.remove(i);n.remove&&(this.current=null,this.$el.closest("div.pull-right").find(".show-source-collection-manage").text(t.choose))},this)},list:function(){var i,n;this.$(".list-cmd-panel div[data-uid]").remove();i=t.choose;this.collection.length&&(this.collection.each(function(n){this.scrollInit?this.$(".list-cmd-panel .mCSB_container").prepend(_.template(e)(n.toJSON())):this.$(".list-cmd-panel").prepend(_.template(e)(n.toJSON()))},this),this.scrollInit?this.$(".list-cmd-panel").mCustomScrollbar("update"):(this.scrollInit=!0,this.$(".list-cmd-panel").mCustomScrollbar()),n=$.cookie(`anbr.check.${this.model.get("typeid")}.sourceid`),this.current||(this.current=n?this.collection.get(n)?this.collection.get(n):this.collection.at(0):this.collection.at(0)),i=this.current.get("SearchPackName"));this.$el.closest("div.pull-right").find(".show-source-collection-manage").text(i)}});return Backbone.View.extend({originalEvents:{"click #clearForm":"clear","click .checkMatches":"check","change #Countries":"viewCountyFields","mouseenter .dropdown-toggle:not(.synonimus-link)":"arise","mouseleave .dropdown-toggle":"off","mouseenter .dropdown-menu":"clearQueue","mouseleave .dropdown-menu":"off","click .font-icon-checkbox":"toggleSynMenage","click label[for=searchSin_INTERN]":"toggleSynMenage","mouseenter #synonims-button .icon-info":"showNote","mouseleave #synonims-button .icon-info":"hideNote","mouseenter .synonims-info":"clearQueue","mouseleave .synonims-info":"hideNote","click button[name=tolist]":"tolist","click button[name=start]:not(.disabled)":"startCheck","click .show-attach-manage":"showAttach","click .hide-attach-manage":"hideAttach","click .show-source-collection-manage":"showSourceCollection","click .hide-source-collection-manage":"hideSourceCollection","mouseenter .show-refer7":"showRefer","mouseleave .show-refer7":"hideRefer","mouseleave .refer7":"hideRefer","mouseenter button":"showtooltip","mouseleave button":"hidetooltip"},addEvents:{},events:function(){return _.extend({},this.originalEvents,this.addEvents)},showtooltip:function(n){$(n.target).closest("button").find(".anbr-tooltip").show()},hidetooltip:function(n){$(n.target).closest("button").find(".anbr-tooltip").fadeOut()},showRefer:function(){this.$(".refer7").clearQueue();this.$(".refer7").slideDown()},hideRefer:function(){this.$(".refer7").delay(100).slideUp()},startCheck:function(i){if(!this.bots.current){Backbone.trigger("message:warning",{message:t.errorselsources});this.$(".show-source-collection-manage").addClass("warning").fadeOut().fadeIn().fadeOut().fadeIn("slow",function(){this.$(".show-source-collection-manage").removeClass("warning")}.bind(this));return}$(i.target).addClass("disabled");this.model.set($.GetData(this.$el));this.model.set("synonyms_INTERN",this.SinPanel.collection.pluck("Value"));this.model.isValid()&&(this.markError(),this.model.url=`/api/startTaskExpress/${this.model.get("typeid")}?sp=${this.bots.current.id}`,Backbone.trigger("message:modal",{title:t.wait2,message:t.message2}),this.model.save({},{wait:!0,success:function(t,i){var r=n.prepare([i])[0].Object_ID;Backbone.trigger("storage:check-add",{id:r,data:i});n.Select.set({query:"CheckList"});n.navigate(n.Select.fullpath(),{trigger:!0});Backbone.trigger("message:hide")}}))},initAttach:function(){var n=new u({model:this.model,el:this.$(".attach-manage")}).render(),i,t;this.listenTo(n,"change:collection",function(){this.$(".amount-files").text(n.collection.length)});i=this.model.get("AttacheedFiles");t=[];_.each(i,function(n,i){var r={FileName:i,FilePath:n};t.push(r)},this);n.collection.reset(t)},getCollectionSource:function(){this.bots=new c({model:this.model}).setElement(this.$(".source-collection-manage"))},showSourceCollection:function(){this.$(".source-collection-manage").slideDown()},hideSourceCollection:function(){this.$(".source-collection-manage").slideUp()},hideAttach:function(){this.$(".attach-manage").slideUp()},showAttach:function(){this.$(".attach-manage").slideDown()},markError:function(n,t){this.$("input").css("border-color","");this.$("textarea").css("border-color","");this.$("select").css("border-color","");_.each(t,function(n){this.$("[name='"+n.name+"']").css("border-color","red")},this)},tolist:function(){n.Select.set("query","CheckList");n.navigate(n.Select.fullpath(),!0)},arise:function(n){var t=$(n.target).closest("button").siblings(".dropdown-menu");t.clearQueue();t.show()},off:function(n){var t=$(n.target).closest(".dropup").find(".dropdown-menu");t.delay(1e3).hide(0)},addSyn:function(){return this.SinPanel=new h({model:this.model}),this.SinPanel},toggleSynMenage:function(n){var t=$(n.target);t.prop("tagName")==="LABEL"?t.siblings(".font-icon-checkbox").toggleClass("checked"):t.toggleClass("checked");this.$(".font-icon-checkbox input").get(0).checked=this.$(".font-icon-checkbox").hasClass("checked")?!0:!1;this.synBeh()},clearQueue:function(n){$(n.target).closest("ul").clearQueue()},showNote:function(){this.$(".synonims-info").clearQueue();this.$(".synonims-info").is(":hidden")&&this.$(".synonims-info").delay(100).slideDown(300)},hideNote:function(){this.$(".synonims-info").clearQueue();this.$(".synonims-info").is(":hidden")||this.$(".synonims-info").delay(500).slideUp(300,function(){$(this).css({padding:"20px 26px 24px",height:"280px",margin:"-275px 0 0 52px",top:"-14px"})})},clear:function(){this.$("input").each(function(){$(this).css("border-color","").val("")});this.$("textarea").each(function(){$(this).css("border-color","").val("")});this.$(".matchesList").empty();this.SinPanel.collection.reset();this.SinPanel.hide();this.SinPanel.hideSyn();this.$("input[name='searchSin_INTERN']").get(0).checked=!1;this.$("input[name='searchSin_INTERN']").closest("div.checkbox").removeClass("checked");this.isChecked=!1;this.model.set($.GetData(this.$el))},check:function(){var i=this.$(".matchesList"),u=this.model.get("typeid"),t,f;this.model.set($.GetData(this.$el));this.model.isValid()&&(this.markError(),i.showIndicator(),t=this.model.toJSON(),f={url:`/api/interestObjects/${u}?page=1`,data:t,type:"POST"},$.ajax(f).done(e=>{this.isChecked?(this.matchesList.operation.params={url:`/api/interestObjects/${u}?page=${s.matchesList.newPage}`,data:t,type:"POST"},this.matchesList.render(e)):(this.matchesList=new r({el:i,operation:{params:f}}),this.matchesList.newPage=n.Select.get("page"),this.matchesList.render(e),this.listenTo(this.matchesList,"to:page",n=>{this.matchesList.newPage=n,this.matchesList.operation.params={url:`/api/interestObjects/${u}?page=${n}`,data:t,type:"POST"},this.matchesList.fetch()}),this.isChecked=!0),i.hideIndicator()}))},viewCountyFields:function(){var n=this.$("select#Countries").val();this.viewCountry(n)},viewCountry:function(n){this.$(".Country").hide();n&&(this.$("#"+n).show(),this.model.set("selectedCountries",[n]))},getCountry:function(){this.$("select#Countries").append("<option value=''>...<\/option>");var n=t.Lang;i.done(function(t){t.each(function(t){t.get("DicCode")==="ByCountry"&&_.each(t.get("DicItems"),function(t){var i=t.DicCodeItem.indexOf(n)!==-1;this.$("select#Countries").append("<option value='"+t.DicCodeItem+"' "+(i?"selected='selected'":"")+">"+t.Title+"<\/option>");i&&this.viewCountry(t.DicCodeItem)},this)},this)},this)}})});