define(["app","i18n!nls/resources","g/lists/TableView","g/semnet/SemNetView","g/ContentView","g/files/AttachFile","g/TinyMCEView","g/DropDownView","text!@/templates/checkProcessTemplate.html","text!@/templates/reportsTemplate.html","@/models/forms/PersonModel","@/models/forms/CompanyModel","text!@/templates/cards/Person.html","text!@/templates/cards/Company.html","report_url","baseurl"],function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){"use strict";var k='<tr data-id="<%= id %>"><td><span class="font-icon font-icon-checkbox"><input type="checkbox" /><\/span><%= title %><\/td><td><span class="font-icon font-icon-<%= status %>"><\/span><\/td><td><%= state %><\/td><td><\/td><\/tr>',d=`<ul class="dropdown-menu">
                            <li class="cmd_info" data-id=""><span role="button" class="disabled"><span class="button-icon"><svg class="svg-icon svg-icon-info"><use xlink:href="#icon-info" /></svg></span><span><%= Resources.information %></span></span></li>
                            <li class="cmd_case" data-id="B7787886-AF0E-4B5A-9061-49B182200B8C"><span role="button"><span class="button-icon"><svg class="svg-icon svg-icon-case-s"><use xlink:href="#icon-case-s" /></svg></span><span><%= Resources.addbasket %></span></span></li>
                            <li class="cmd_trash" data-id="86056534-0DCB-48CF-B06D-3E8D23FD5001"><span role="button"><span class="button-icon"><svg class="svg-icon svg-icon-trash-s"><use xlink:href="#icon-trash-s" /></svg></span><span><%= Resources.deleteItem %></span></span></li>
                            <li class="cmd_analyst"><a href="/" target="_blank" class="external link"><span class="button-icon"><svg class="svg-icon svg-icon-analyst"><use xlink:href="#icon-analyst" /></svg></span><span><%= Resources.toanal %></span></a></li>
                        </ul>`,g=`<div class='presentPanel'><div class='pie disabled'><div class='right'><label><%= Resources.stateResult %>:</label>&nbsp;&nbsp;<div class='dropdown list-area disabled'></div></div>
                            <button class='btn edit'><svg class='svg-icon'><use xlink:href='#icon-edit' /></svg><span><%= Resources.edit %></span></button></div>
                            <div class='presentText'><%= text %></div></div><div class='editPanel'>
                            <div class='pie'><div class='right'><label><%= Resources.stateResult %>:</label>&nbsp;&nbsp;<div class='dropdown list-area'></div></div>
                            <button class='btn btn-blue save'><svg class='svg-icon'><use xlink:href='#icon-save' /></svg><span><%= Resources.save %></span></button>&nbsp;&nbsp;<button class='btn cancel'><svg class='svg-icon'><use xlink:href='#button-cancel' /></svg><span><%= Resources.cancel %></span></button></div><div class='htmlEditor'></div></div>`,nt=`<div class='item'><span class='font-icon font-icon-flag'></span><%= Resources.positive %></div>
        <div class='item'><span class='font-icon font-icon-help'></span><%= Resources.doubts %></div>
        <div class='item'><span class='font-icon font-icon-dislike'></span><%= Resources.negative %></div>`,w={},b=Backbone.View.extend({originalEvents:{"click a:not('.link').jump":"jump","mouseenter .anbr-toolbar button":"showtooltip","mouseleave .anbr-toolbar button":"hidetooltip"},addEvents:{},events:function(){return _.extend({},this.originalEvents,this.addEvents)},jump:function(n){n.preventDefault();n.stopPropagation();var t=$(n.target).closest("a");this.tab(t).trans(t.attr("href"))},tab:function(n){return this.$("ul.nav li.active").removeClass("active"),this.$("div.tab-pane").hide(),n.parent().addClass("active"),this},showtooltip:function(n){$(n.target).closest("button").find(".anbr-tooltip").show()},hidetooltip:function(n){$(n.target).closest("button").find(".anbr-tooltip").fadeOut()},trans:function(n){this.ActiveTabName=n;this.$(n).show();this.$(".anbr-toolbar").hide();this.$(".anbr-toolbar button").hide();var t=n.replace("#","").replace("-","");return this[t](n),this},done:function(n,t){return this.callback=n,this.context=t,this},setCurrent:function(n){return n=n||this.$(".nav a:first-child").attr("href"),this.tab(this.$("a[href='"+n+"']")).trans(n),this}}),tt=b.extend({el:$("#check-process"),addEvents:{"click .open-sources":"showSources","click .tool-extra1":"showExtra","change select.check-date":"getPart","click .list-sources .dropdown-menu_close":"removeSource"},showSources:function(){this.winSources.show()},showExtra:function(){Backbone.trigger("message:warning",{title:"Alert!",message:"Opportunity is temporarily unavailable - is under development"})},trans:function(n){var r,u;this.ActiveTabName=n;this.$(n).show();r=this.storage[n];r.buttons.length?(this.$(".anbr-toolbar").show(),_.map(r.buttons,function(n){this.$("."+n).show()},this)):this.$(".anbr-toolbar").hide();r.table||(u=r.name==="extract"?"":d,r.table=new i({template:r.templ,head:r.head,foot:u}).setElement(n).render(),this.listenTo(r.table,"to:page",function(t){this.currentPage=t;this.get(r.url+this.objID+("?page="+t),r.table,n)},this),this.$(n).append(r.table.$el),this.$(n).append("<p class='info'>"+t.nodata+"<\/p>"));this.get(r.url+this.objID+"?page=1",r.table,n)},get:function(n,t,i){var r=t.$el.next(".info"),u=this.$("a[href='"+i+"'] span.numchild");t.$el.showIndicator();$.get(n+this.filterParams).done(function(n){t.collection.reset(n);var i=t.collection.get(0);i?(u.text("("+i.get("num")+")"),t.collection.length-1?r.hide():r.show()):(u.text("("+t.collection.length+")"),t.collection.length-1?r.hide():r.show())}).always(function(){t.$el.hideIndicator()})},initialize:function(){this.objID=this.model.id;this.currentPage=1;this.filterParams="";this.storage={"#result-extract":{name:"extract",buttons:[],url:"/api/Docs/InfoDB/",templ:"<tr data-id='<%= id %>'><td><% if(size){ %><a href='#doc!sid=<%= id %><% if(originoid){ %>?originoid=<%= originoid %><% } %>' target='_blank' class='link'><%= title %><\/a><% } else { %><%= title %><% } %><\/td><td><%= source %><\/td><td class='controls'><button class='btn-link'><span><\/span><\/button><\/td><\/tr>",head:'<tr><th><%= Resources.titlehead %><\/th><th class="spike"><%= Resources.source %><\/th><th><\/th><\/tr>'},"#result-facts":{name:"fact",buttons:[],url:"/api/facts/",head:'<tr><th><%= Resources.title %><\/th><th class="spike"><%= Resources.type %><\/th><th><\/th><\/tr>',templ:"<tr data-id='<%= id %>'><td><% if(linkToSourceID){ %><a href='#fact!sid=<%= id %><% if(originoid){ %>?originoid=<%= originoid %><% } %>' target='_blank' class='link'><%= title %><\/a><% } else { %><%= title %><% } %><\/td><td><%= type %><\/td><td class='controls'><button class='btn-link'><span><\/span><\/button><\/td><\/tr>"},"#result-documents":{name:"doc",buttons:["tool-extra1"],url:"/api/Docs/",head:'<tr><th><span class="font-icon font-icon-checkbox"><input type="checkbox" /><\/span><%= Resources.titlehead %><\/th><th class="spike"><%= Resources.source %><\/th><th><%= Resources.size %> (Kb)<\/th><th><\/th><\/tr>',templ:"<tr data-id='<%= id %>'><td><span class='font-icon font-icon-checkbox'><input type='checkbox' /><\/span><% if(size){ %><a href='#doc!sid=<%= id %><% if(originoid){ %>?originoid=<%= originoid %><% } %>' target='_blank' class='link'><%= title %><\/a><% } else { %><%= title %><% } %><\/td><td><%= source %><\/td><td><%= size %><\/td><td class='controls'><button class='btn-link'><span><\/span><\/button><\/td><\/tr>"},"#result-requisites":{name:"requisit",buttons:[],url:"/api/requisit/",head:'<tr><th><%= Resources.title %><\/th><th class="spike"><%= Resources.type %><\/th><th><\/th><\/tr>',templ:"<tr data-id='<%= id %>'><td><%= title %><\/td><td><%= type %><\/td><td class='controls'><button class='btn-link'><span><\/span><\/button><\/td><\/tr>"}};var n=`/api/checkready/${this.objID}?kind=0`;require(["signalR"],function(){require(["/signalr/hubs"],function(){require(["/scripts/IWC-SignalR-master/signalr-patch.js","/scripts/IWC-SignalR-master/iwc-signalr.js"],function(){var n=SJ.iwc.SignalR.getHubProxy("Ticker",{client:{updateRobot:function(n){console.log("SignalR > Update robots",{robot:n});this.update(n)},infoActiveChecks:function(n){console.log("SignalR > Info active checks",{ids:n});this.infoActiveChecks(n)}}})}.bind(this))}.bind(this))}.bind(this));this.chcInt=setInterval(function(){$.get(n).done(function(n){this.result(n)}.bind(this)).fail(function(){clearInterval(this.chcInt)}.bind(this))}.bind(this),3e3)},result:function(t){if(t===200&&(this.isRender||this.render(),clearInterval(this.chcInt)),!this.isMonitoring){var i=n.getContext();this.isMonitoring=!0;this.startMonitoring(i.key,this.objID)}},startMonitoring:function(n,t){var i=this;require(["signalR"],function(){require(["/signalr/hubs"],function(){require(["/scripts/IWC-SignalR-master/signalr-patch.js","/scripts/IWC-SignalR-master/iwc-signalr.js"],function(){var i=SJ.iwc.SignalR.getHubProxy("Ticker",{client:{}});console.log("SignalR > Statr monitoring tasks",{objectID:t});i.server.startMonitoringTasks(n,t);console.log("SianalR Hub",{hub:i})})})})},infoActiveChecks:function(n){n.length?_.map(n,function(n){this.model.id===n&&(this.initStatistic()?$("#statistic-info").show():$("#statistic-info").hide())},this):($("#statistic-info").hide(),this.stopMonitoring())},stopMonitoring:function(){},update:function(n){var t,i;this.model.id==n.objID&&(t=this.winSources.$el.find("tr[data-id="+n.id+"]"),t.get(0)?(i=t.find("td"),i.eq(1).html('<span class="font-icon font-icon-'+n.status+'"><\/span>'),i.eq(2).text(n.state)):this.winSources.$el.find("table>tbody").append(_.template(k)(n)),this.initStatistic())},initStatistic:function(){var i=this.winSources.$el.find("table>tbody tr").size(),r=this.winSources.$el.find("table>tbody tr td span.font-icon-invalid").size(),u=this.winSources.$el.find("table>tbody tr td span.font-icon-complited").size(),n=i-(u+r);return $("#statistic-info span:first").text(t.working+": "+n),n?$("#statistic-info").show():(this.stopMonitoring(),$("#statistic-info").hide()),this},initSources:function(){this.winSources=new it({el:this.$("#sources-window"),model:this.model}).render();this.listenTo(this.winSources,"source:filter",this.sourceFilter);this.winSources.listenTo(this,"remove:selection",this.winSources.selection);this.selectedSourceCollection=new Backbone.Collection;this.selectedSourceCollection.on("add",this.listSources,this);this.selectedSourceCollection.on("remove",this.listSources,this);return this},sourceFilter:function(n){n.checked?this.selectedSourceCollection.add(n.model):this.selectedSourceCollection.remove(n.model)},listSources:function(){var n,t;this.$(".list-sources").empty();this.selectedSourceCollection.length?this.$(".open-sources>.dropdown-menu_arrow").css("display","inline-block"):this.$(".open-sources>.dropdown-menu_arrow").hide();n=[];this.selectedSourceCollection.each(function(t){this.$(".list-sources").append(_.template("<span class='item' data-id='<%= id %>'><span class='dropdown-menu_close'><svg class='svg-icon icon-close'><use xlink:href='#icon-close' /><\/svg><\/span><%= title %><\/span>")(t.toJSON()));n.push(t.get("searchSATaskID"))},this);t=_.findWhere(w.Part,{date:this.$("select.check-date").val()});this.filterParams="&uid="+t.uid+"&ids="+n.join(",");this.trans(this.ActiveTabName)},removeSource:function(n){n.stopPropagation();var t=$(n.target).closest("span.item").attr("data-id"),i=this.selectedSourceCollection.get(t);this.selectedSourceCollection.remove(i);this.trigger("remove:selection",t)},render:function(){return this.isRender=!0,this.$el.html(_.template(s)({Resources:t})),this.setCurrent().initSources().initStatistic(),w.Part?this.final():$.get("/api/CheckRes/"+this.model.id).done(this.write.bind(this)),this},write:function(n){w.Part=n;this.getPart();this.final()},getPart:function(n){var i=w.Part[0].date,t=JSON.parse(w.Part[0].data);n&&(i=$(n.target).val(),t=_.findWhere(w.Part,{date:i}),t=t?JSON.parse(t.data):[]);this.winSources.table.collection.reset(t)},final:function(){this.$("select.check-date").empty();_.each(w.Part,function(n){this.$("select.check-date").append("<option value='"+n.date+"'>"+new Date(n.date).toLocaleString(t.Lang)+"<\/option>")},this);this.callback&&this.callback.call(this.context)}}),it=Backbone.View.extend({events:{"click .icon-close":"hide","click .font-icon-checkbox":"filter"},cbx:function(n){n.hasClass("checked")?n.removeClass("checked"):n.addClass("checked");var t=n.find("input");t.get(0).checked=!t.get(0).checked},filter:function(n){var r=$(n.target),f=r.find("input"),u=r.closest("tr").attr("data-id"),i=this.table.collection.get(u);i&&i.get("status")==="complited"&&i.get("severity")!==404?(this.cbx(r),this.trigger("source:filter",{model:i,checked:r.hasClass("checked")})):Backbone.trigger("message:warning",{title:t.alert,message:i.get("state")})},selection:function(n){var t=this.$("tr[data-id='"+n+"']").find(".font-icon-checkbox");this.cbx(t)},hide:function(){this.$el.slideUp()},show:function(){this.$el.slideDown()},render:function(){return this.table=new i({template:'<tr data-id="<%= id %>"><td><span class="font-icon font-icon-checkbox"><input type="checkbox" /><\/span><%= title %><\/td><td><span class="font-icon font-icon-<%= status %>"><\/span><\/td><td><%= state %><\/td><td><\/td><\/tr>',head:'<tr><th><span class="font-icon font-icon-checkbox"><input type="checkbox" /><\/span><%= Resources.title %><\/th><th><%= Resources.status %><\/th><th><%= Resources.execution %><\/th><th><\/th><\/tr>',isScroll:!0,el:this.$(".content-table")}).render(),this}}),rt=Backbone.View.extend({el:$("#init-data"),events:{"click .show-attach-manage":"showAttachManage","click .hide-attach-manage":"hideAttachManage","click .clear":"clearItem"},clearItem:function(n){var t=$(n.target).closest("span"),i=t.attr("data-name"),r=this.attach.collection.get(i);t.remove();this.attach.collection.remove(r)},initialize:function(){var n=this;$.get("/api/interestObjects/input/id"+this.model.id).done(function(t){n.render(t)})},render:function(n){var r={10021:[a,c],10022:[v,l]},u=new r[n.typeid][1](n),i=u.toJSON();return i.Resources=t,this.$el.html(_.template(r[n.typeid][0])(i)),this.$("#"+i.selectedCountries[0]).show(),this.initAttachFile(n),this},hideAttachManage:function(){this.$(".attach-manage").slideUp()},showAttachManage:function(){this.$(".attach-manage").slideDown()},initAttachFile:function(n){var i=n.AttacheedFiles,t;this.attach=new f({el:this.$(".attach-manage")}).render();this.listenTo(this.attach,"change:collection",function(){this.fillList();this.attach.setModel();n.AttacheedFiles=this.attach.output;$.ajax({type:"POST",url:"/api/InterestObj/SaveObjectData",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)})});t=[];_.each(i,function(n,i){var r={FileName:i,FilePath:n};t.push(r)},this);this.attach.collection.reset(t);this.fillList()},fillList:function(){this.$(".amount-files").text(this.attach.collection.length);this.filesList(this.attach.collection)},filesList:function(n){this.$(".attached-files-list").empty();n.each(function(n){this.$(".attached-files-list").append(_.template("<span data-name='<%= FileName %>'><a href='<%= FilePath %>' target='_blank' class='view link'><svg class='svg-icon icon-file'><use xlink:href='#icon-file'><\/use><\/svg><%= FileName %><\/a>"+"<button type='button' class='clear'><svg class='svg-icon icon-close'><use xlink:href='#icon-close'><\/use><\/svg><\/button><\/span>")(n.toJSON()))},this)}}),ut=b.extend({el:$("#check-reports"),addEvents:{"click .font-icon-checkbox":"check","click .tool-upload":"send","click .icon-email":"sendemail"},comp:function(){var n={Sec1Reports:{},Sec2Reports:{},Sec3Reports:{}};return this.$(".font-icon-checkbox").each((t,i)=>{if($(i).hasClass("checked")){let r=parseInt($(i).closest("tr").attr("data-id")),t=$(i).closest("table").attr("data-role");n[t]&&(n[t][r]=$(i).next("a").text())}}),n},sendemail:function(){this.post.set({Action:1,Email:this.$("input[name=sender]").val()});this.sendData()},send:function(){this.post.set({Action:0,Email:""});this.sendData()},sendData:function(){let n=this.comp();this.post.set({ObjID:this.model.id,Sec1Reports:n.Sec1Reports,Sec2Reports:n.Sec2Reports,Sec3Reports:n.Sec3Reports});this.post.save({},{success:n=>Backbone.trigger("message:success",{message:Object.keys(n.attributes)[0]})})?(this.post.clear(),this.$("input[name=sender]").val("")):Backbone.trigger("message:warning",{message:this.post.validationError})},check:function(n){let t=$(n.target);t.hasClass("checked")?t.removeClass("checked"):t.addClass("checked");t.hasClass("head")&&(t.hasClass("checked")?this.$("table tr>td .font-icon-checkbox").addClass("checked"):this.$("table tr>td .font-icon-checkbox").removeClass("checked"))},initialize:function(){let n=Backbone.Model.extend({defaults:{ObjID:this.model.id,Sec1Reports:{},Sec2Reports:{},Sec3Reports:{},Action:0,Email:""},url:"/api/Report/UploadReportsArchived",validate:function(n){var i=[];return Object.keys(n.Sec1Reports).length||Object.keys(n.Sec2Reports).length||Object.keys(n.Sec3Reports).length||i.push(t.noselect),!n.Action||$.trim(n.Email)&&this.test(n.Email,/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)||i.push(t.errorEmail),i.length?i.join("<br/>"):void 0},test:function(n,t){return n==""||new RegExp(t).test(n)}});this.post=new n;this.storage={"#reports-all":{name:"all",buttons:["tool-upload"],url:[{name:"reports",url:"/api/report/",templ:`<tr data-id='<%= id %>'><td><div><span class='font-icon font-icon-checkbox'><input type='checkbox' /></span>
                                <a href='<%= baseurl %>/SqlRepPage.aspx?rid=<%= id %>&pid=<%= originoid %>' target='_blank' class='link'><%= title %></a></span></div></td></tr>`},{name:"extracts",url:"/api/Docs/InfoDB/",par:"?page=1&od=1",templ:"<tr data-id='<%= id %>'><td><div><span class='font-icon font-icon-checkbox'><input type='checkbox' /><\/span><% if(size){ %><a href='#doc!sid=<%= id %><% if(originoid){ %>?originoid=<%= originoid %><% } %>' target='_blank' class='link'><%= title %> (<%= source %>)<\/a><% }else{ %><span><%= title %> (<%= source %>)<\/span><% } %><\/div><\/td><\/tr>"}]}};this.render()},bild:function(n,t){if(!t.length){this.$(`.${n.name}`).hide();return}Array.from(t,t=>{t.id&&(t.baseurl=p,t.originoid=this.model.id,this.$(`.${n.name}>tbody`).append(_.template(n.templ)(t)))},this)},reportsall:function(n){var t=this.storage[n];if(t.buttons.length&&(this.$(".anbr-toolbar").show(),_.map(t.buttons,n=>this.$(`.${n}`).show())),this.isInit)return this;this.isInit=!0;Array.from(t.url,n=>$.get(`${n.url}${this.model.id}${n.par?n.par:""}`).done(this.bild.bind(this,n)))},reportsreports:function(){return this},render:function(){var n=`${y}?pid=${this.model.id}`;return this.$el.html(_.template(h)({Resources:t,report_url:n})),w.Part?this.final():$.get(`/api/CheckRes/${this.model.id}`).done(n=>{w.Part=n,this.final()}),this},final:function(){this.$("select.check-date").empty();Array.from(w.Part,n=>this.$("select.check-date").append(`<option value='${n.date}'>${new Date(n.date).toLocaleString(t.Lang)}</option>`));this.callback&&this.callback.call(this.context)}}),ft=Backbone.View.extend({events:{"click .edit":"editResult","click .cancel":"cancelResult","click .save":"saveResult"},editResult:function(){this.$(".presentPanel").hide();this.$(".editPanel").show()},cancelResult:function(){this.$(".presentPanel").show();this.$(".editPanel").hide()},saveResult:function(){var n=this.htmlEditor.getContent();this.$(".presentText").html(n)},initialize:function(){this.render()},render:function(){var n="";return this.$el.html(_.template(g)({Resources:t,text:n})),this.dropdown=new o({el:this.$(".dropdown"),template:nt}).render(),this.listenTo(this.dropdown,"dropdown:select",function(){}),this.htmlEditor=new e({text:n}).setElement(this.$(".htmlEditor")).render(),this}});return b.extend({el:$("#ResultDetails"),checkprocess:function(){if(this.isProcess){var n="#result-extract";this.process.tab(this.$("a[href='"+n+"']")).trans(n)}else this.isProcess=!0,this.process=new tt({model:this.model}).done(function(){this.callback&&this.callback.call(this.context)},this);return this},initdata:function(){return this.isInitData||(this.isInitData=!0,this.initData=new rt({model:this.model})),this},checkreports:function(){return this.initReports||(this.initReports=new ut({model:this.model})),this.initReports.setCurrent(),this},smanticrel:function(){return r.get().setElement(this.$("#SemNet")).render(this.model.id),this},result:function(){return this.isResult||(this.isResult=!0,new ft({el:this.$("#result"),model:this.model})),this},initialize:function(n){this.model=new Backbone.Model({id:n.id});this.model.url="/api/details/"+this.model.id+"?mode=1";this.model.on("sync",this.render,this);this.model.fetch()},render:function(){var n="#check-process";return this.$(".obj-title").text(this.model.get("title")),this.tab(this.$("a[href='"+n+"']")),this.trans(n),this}})});