define(["i18n!nls/resources"],function(n){"use strict";var r='<div class="sources-head-panel"><div class="input-group-search"><input class="form-control" type="text" placeholder="<%= Resources.searchByWord %>" id="SearchText" /><span role="button" id="SearchByText"><svg class="icon icon-search"><use xlink:href="#icon-search"><\/use><\/svg><\/span><\/div><div><span class="btn-link-clear All" role="button"><svg class="icon icon-filtered"><use xlink:href="#icon-filtered"><\/use><\/svg><%= Resources.allSources %><\/span><span class="btn-link-clear Only" role="button"><svg class="icon icon-select"><use xlink:href="#icon-select"><\/use><\/svg><%= Resources.selected2 %>&nbsp;<span class="amount-selected"><\/span><\/span><span class="dropdown-menu_arrow"><\/span><\/div><\/div><table class="table table-hover" id="SourcesList"><thead><tr><th><div class="checkbox AllItems"><label><input type="checkbox" /><\/label><\/div><\/th><th>№<\/th><th><%= Resources.title %><\/th><th class="text-center"><%= Resources.price %> <span class="Currency"><\/span><\/th><\/tr><\/thead><tbody><\/tbody><\/table><table class="table table-hover" id="SelectedList" style="display: none;"><thead><tr><th><div class="checkbox checked AllItems"><label><input type="checkbox" checked="checked" /><\/label><\/div><\/th><th>№<\/th><th><%= Resources.title %><\/th><th class="text-center"><%= Resources.price %> <span class="Currency"><\/span><\/th><\/tr><\/thead><tbody><\/tbody><\/table>',u='<td><div class="checkbox"><label><input type="checkbox" /><\/label><\/div><\/td><td><%= num %><\/td><td><div class="btn-group dropright"><button type="button" class="dropdown-toggle btn-clear" aria-haspopup="true" aria-expanded="false"><%= title %><\/button><div class="dropdown-menu"><span class="dropdown-menu_arrow"><\/span><span class="dropdown-menu_close"><svg class="icon icon-close"><use xlink:href="#icon-close"/><\/svg><\/span><div class="menu-info-source"><div class="source-logo"><img src="<%= logoUrl?logoUrl:\'/images/photo.png\' %>" alt="" /><\/div><div class="source-title"><%= title %><\/div><div class="source-desc"><ul><% _.each(property, function(item){ %><li><%= item %><\/li><% }) %><\/ul><p><%= description %><\/p><\/div><\/div><\/div><\/div><\/td><td class="text-center"><%= price?price:Resources.freeTitle %><\/td>',f=Backbone.Model.extend({defaults:{id:null,title:"",property:[],description:"",price:0,currency:""}}),t=Backbone.Collection.extend({model:f,url:function(){return"/api/sources"}}),i=Backbone.View.extend({tagName:"tr",events:{"click .checkbox label":"checkbox","click button":"viewDetail","click .dropdown-menu":"hideDetail"},hideDetail:function(){this.$(".dropright").removeClass("open")},viewDetail:function(){this.$el.siblings("tr").each(()=>$(this).find(".dropright").removeClass("open"));this.$(".dropright").addClass("open");this.$(".dropdown-menu").css("margin-top",-200);this.$(".dropdown-menu_arrow").css("margin-top",198);var t=$(window).height(),n=this.$(".dropdown-menu").offset().top-$(document).scrollTop();return t-n<this.$(".dropdown-menu").height()&&this.$(".dropdown-menu").css("margin-top",-200+(t-n)-(this.$(".dropdown-menu").height()+40)),n<0&&this.$(".dropdown-menu").css("margin-top",-200+Math.abs(n)+20),this},checkbox:function(n){var t=$(n.target).closest("div.checkbox"),i=t.find("input[type=checkbox]");if(t.hasClass("disabled"))return null;i.is(":checked")!==t.hasClass("checked")&&this.selectItem(i.is(":checked"));i.is(":checked")?(this.$el.addClass("selected"),t.addClass("checked")):(this.$el.removeClass("selected"),t.removeClass("checked"))},selectItem:function(n){var t=this.collection.isBasket?this.collection:this.collection.basket;n?t.add(this.model):t.remove(this.model)},initialize:function(n){this.model=n.model;this.collection=n.collection},render:function(){let t=this.model.toJSON();return t._=_,t.Resources=n,this.$el.html(_.template(u)(t)),this.$el.attr("data-id",this.model.id),this.collection.isBasket&&(this.$el.addClass("selected"),this.$("div.checkbox").addClass("checked"),this.$("input[type=checkbox]").get(0).checked=!0),this}});return Backbone.View.extend({events:{"keypress input#SearchText":"searchByKey","click #SearchByText":"search","click .All":"all","click .Only":"only","click #SourcesList .AllItems:not([class='disabled'])":"checkSources","click #SelectedList .AllItems:not([class='disabled'])":"checkSelected"},checkSelected:function(n){var t=$(n.target).closest("div.checkbox"),i=t.find("input[type=checkbox]"),r;if(t.hasClass("disabled"))return null;i.is(":checked")===t.hasClass("checked")||i.is(":checked")||(r=[],this.basket.each(n=>{r.push(n.id),this.changeMark(n,!1)}),this.basket.reset(),this.changeMark(null,!1,this.$("#SourcesList tr:first")));this.mcbx(i,t)},checkSources:function(n){var t=$(n.target).closest("div.checkbox"),i=t.find("input[type=checkbox]"),r,u;if(t.hasClass("disabled"))return null;i.is(":checked")!==t.hasClass("checked")&&(r=i.is(":checked"),u=[],this.collection.each(n=>{this.changeMark(n,r),r?this.basket.add(n):this.basket.remove(n),u.push(n.id)}));this.mcbx(i,t)},mcbx:function(n,t){n.is(":checked")?(this.$el.addClass("selected"),t.addClass("checked")):(this.$el.removeClass("selected"),t.removeClass("checked"))},byfilter:function(n){return this.paramsSearch=n,this.search(),this},searchByKey:function(n){n.keyCode==13&&$.trim(this.$("#SearchText").val())&&this.search()},search:function(){return this.paramsSearch.DicItems=this.paramsSearch.DicItems||[],this.paramsSearch.SearchText=this.$("#SearchText").val(),this.paramsSearch.DicItems.push(this.model.get("BySaType")),this.$("#SourcesList>thead").showIndicator(),$.post("/api/sources/filterby",this.paramsSearch).done(n=>this.collection.reset(n)),this},all:function(){this.mark();this.$("#SelectedList").hide();this.$("#SourcesList").show();this.$(".All").addClass("S");this.$(".Only").removeClass("S");this.$(".sources-head-panel .dropdown-menu_arrow").css("left","69px")},only:function(){this.changeMark(null,this.basket.length,this.$("#SelectedList tr:first"));this.$("#SelectedList").show();this.$("#SourcesList").hide();this.$(".All").removeClass("S");this.$(".Only").addClass("S");this.$(".sources-head-panel .dropdown-menu_arrow").css("left","210px")},mark:function(){this.basket.each(n=>this.changeMark(n,!0))},changeMark:function(n,t,i){var r=i||this.$(`#SourcesList>tbody>tr[data-id='${n.id}']`);t?(r.addClass("selected"),r.find("div.checkbox").addClass("checked")):(r.removeClass("selected"),r.find("div.checkbox").removeClass("checked"));r.find("input[type=checkbox]").get(0)&&(r.find("input[type=checkbox]").get(0).checked=t)},list:function(n,t){t.empty();Array.from(n.models,(r,u)=>{r.set("num",u+1),t.append(new i({model:r,collection:n}).render().$el)})},addOneSelected:function(n){this.changeMark(n,!0);n.set("num",this.basket.length);this.$("#SelectedList tbody").append(new i({model:n,collection:this.basket}).render().$el);this.$(".amount-selected").text(`(${this.basket.length})`);this.trigger("change:selected")},clearOneSelected:function(n){this.changeMark(n,!1);this.list(this.basket,this.$("#SelectedList tbody"));this.$(".amount-selected").text(`(${this.basket.length})`);this.trigger("change:selected")},changecollection:function(n){this.model=n;this.$("#SourcesList>tbody>tr").each((n,t)=>{let i=$(t);i.removeClass("selected");i.find("div.checkbox").removeClass("checked");i.find("input[type=checkbox]").get(0).checked=!1});this.model.get("IsSystem")?(this.$("#SourcesList>tbody>tr").each((n,t)=>$(t).find("div.checkbox").addClass("disabled")),this.$("#SourcesList>thead>tr").each((n,t)=>$(t).find("div.checkbox").addClass("disabled"))):(this.$("#SourcesList>tbody>tr").each((n,t)=>$(t).find("div.checkbox").removeClass("disabled")),this.$("#SourcesList>thead>tr").each((n,t)=>$(t).find("div.checkbox").removeClass("disabled")));this.$("#SelectedList>thead").showIndicator();this.model.id?(this.basket.url="/api/sources/persisted/"+this.model.id,this.basket.fetch({reset:!0})):this.basket.reset()},resetSources:function(n){return this.list(n,this.$("#SourcesList tbody")),this.model.id&&!this.initBasket?(this.initBasket=!0,this.basket.url=`/api/sources/persisted/${this.model.id}`,this.basket.fetch({reset:!0})):this.initBasket?this.resetSelected():this.trigger("change:selected"),this.model.get("IsSystem")?(this.$("#SourcesList>tbody>tr").each((n,t)=>$(t).find("div.checkbox").addClass("disabled")),this.$("#SourcesList>thead>tr").each((n,t)=>$(t).find("div.checkbox").addClass("disabled"))):this.$("#SourcesList>thead>tr").each((n,t)=>$(t).find("div.checkbox").removeClass("disabled")),this.$("#SourcesList>thead").hideIndicator(),this},resetSelected:function(){this.list(this.basket,this.$("#SelectedList tbody"));this.model.get("IsSystem")?(this.$("#SelectedList>tbody>tr").each((n,t)=>$(t).find("div.checkbox").addClass("disabled")),this.$("#SelectedList>thead>tr").each((n,t)=>$(t).find("div.checkbox").addClass("disabled"))):this.$("#SelectedList>thead>tr").each((n,t)=>$(t).find("div.checkbox").removeClass("disabled"));this.all();this.$("#SelectedList>thead").hideIndicator();this.$(".amount-selected").text(`(${this.basket.length})`);this.trigger("change:selected")},initialize:function(){this.paramsSearch={};this.basket=new t;this.basket.isBasket=!0;this.basket.on("reset",this.resetSelected,this);this.basket.on("add",this.addOneSelected,this);this.basket.on("remove",this.clearOneSelected,this);this.collection=new t;this.collection.basket=this.basket;this.collection.on("reset",this.resetSources,this)},render:function(){return this.$el.html(_.template(r)({Resources:n})),this}})});